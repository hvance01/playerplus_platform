# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**PlayerPlus Platform** - å†…éƒ¨ AI å·¥å…·å¹³å°ï¼Œæä¾›è§†é¢‘æ¢è„¸ã€Prompt ç®¡ç†ã€AI æ–‡æ¡ˆç”Ÿæˆç­‰èƒ½åŠ›ã€‚

## äº¤äº’è§„åˆ™ï¼ˆå…¨å±€è‡ªåŠ¨ Compactï¼‰

- Claude Code å¿…é¡»æŒç»­å…³æ³¨ Claude æ§åˆ¶å°çš„ context ä½¿ç”¨æŒ‡ç¤ºã€‚åªè¦æ˜¾ç¤ºâ€œå·²ä½¿ç”¨ â‰¥80% / å‰©ä½™ â‰¤20%â€ï¼Œå°±ç«‹åˆ»æ‰§è¡Œä¸€æ¬¡ `Compact` å¹¶å‘ç”¨æˆ·è¯´æ˜è§¦å‘åŸå› ã€‚
- æ¯æ¬¡æ‰§è¡Œé«˜ context æ¶ˆè€—çš„æ“ä½œï¼ˆä¾‹å¦‚ï¼šç²˜è´´æˆ–ç”Ÿæˆå¤§æ®µ diff/æ—¥å¿—/æµ‹è¯•è¾“å‡ºã€å¤šæ–‡ä»¶é•¿æ–‡ã€>300 token çš„æ¨ç†è¯´æ˜ç­‰ï¼‰åï¼Œå…ˆè‡ªæŸ¥ä¸€æ¬¡ context ä½¿ç”¨ï¼›è‹¥è¾¾åˆ°ä¸Šè¿°é˜ˆå€¼ç«‹å³ `Compact`ï¼Œè‹¥æœªè¾¾åˆ°ä¹Ÿéœ€åœ¨æ¥ä¸‹æ¥çš„ä¸¤æ¡å›å¤å†…å†æ¬¡å¤æŸ¥ã€‚
- é™¤éç”¨æˆ·æ˜ç¡®è¦æ±‚â€œä¸è¦ compactâ€ï¼Œå¦åˆ™æœ¬ç­–ç•¥åœ¨æ•´ä¸ªä»“åº“çš„ä»»ä½•ä¼šè¯ä¸­éƒ½å¿…é¡»ä¼˜å…ˆç”Ÿæ•ˆï¼ŒåŒ…æ‹¬å­ç›®å½•ï¼ˆ`backend/`, `frontend/` ç­‰ï¼‰çš„ç‹¬ç«‹å¯¹è¯ã€‚

### æ¨¡å—æ–‡æ¡£

- **åç«¯å¼€å‘**: [backend/CLAUDE.md](backend/CLAUDE.md)
- **å‰ç«¯å¼€å‘**: [frontend/CLAUDE.md](frontend/CLAUDE.md)

## Tech Stack

| Layer | Technology |
|-------|------------|
| Backend | Go 1.22+ / Gin / PostgreSQL |
| Frontend | Vue 3 / TypeScript / Ant Design Vue |
| Storage | Cloudflare R2 (S3 å…¼å®¹) |
| CDN | VPS (LA, CN2) + Nginx åå‘ä»£ç† |
| Deployment | Railway (å•äºŒè¿›åˆ¶) |

## Project Structure

```
playerplus_platform/
â”œâ”€â”€ backend/                 # Go åç«¯ â†’ è¯¦è§ backend/CLAUDE.md
â”‚   â”œâ”€â”€ cmd/server/          # å…¥å£
â”‚   â””â”€â”€ internal/            # ä¸šåŠ¡ä»£ç 
â”œâ”€â”€ frontend/                # Vue å‰ç«¯ â†’ è¯¦è§ frontend/CLAUDE.md
â”‚   â””â”€â”€ src/                 # æºç 
â”œâ”€â”€ Makefile                 # ç»Ÿä¸€æ„å»ºå‘½ä»¤
â”œâ”€â”€ railway.json             # Railway éƒ¨ç½²é…ç½®
â””â”€â”€ README.md                # é¡¹ç›®è¯´æ˜
```

## External APIs

| Service | Description | Status |
|---------|-------------|--------|
| VModel API | è§†é¢‘äººè„¸æ£€æµ‹ä¸æ¢è„¸ | âœ… å·²é›†æˆ |
| Cloudflare R2 | å¯¹è±¡å­˜å‚¨ | âœ… å·²é›†æˆ |
| VPS CDN | ä¸­å›½è®¿é—®åŠ é€Ÿ (CN2) | âœ… å·²é›†æˆ |
| Resend | é‚®ä»¶å‘é€æœåŠ¡ | ğŸš§ å¾…é…ç½® |
| LLM API | æ–‡æ¡ˆç”Ÿæˆ | ğŸ“‹ å¾…å®š |

### VModel API

- äººè„¸æ£€æµ‹: `POST /api/predictions` (video-face-detect)
- æ¢è„¸æ‰§è¡Œ: `POST /api/predictions` (video-multi-face-swap)
- ç»“æœæŸ¥è¯¢: `GET /api/predictions/:id`

## éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ä¸­å›½ç”¨æˆ·è®¿é—®æµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   ä¸­å›½ç”¨æˆ· â”€â”€(CN2ä¼˜åŒ–)â”€â”€> VPS (LA) â”€â”€> Railway åç«¯                      â”‚
â”‚                            â”‚                                            â”‚
â”‚                            â””â”€â”€> Cloudflare R2 (åª’ä½“æ–‡ä»¶)                 â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           VModel API è®¿é—®æµç¨‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   VModel API â”€â”€(ç›´è¿)â”€â”€> Cloudflare R2 (ç»•è¿‡CDNï¼Œé¿å…è¶…æ—¶)               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŸŸåé…ç½®

| åŸŸå | ç”¨é€” | æŒ‡å‘ |
|------|------|------|
| `platform.playerplus.cn` | å¹³å°ä¸»åŸŸå | VPS (31.40.214.114) |
| `cdn.playerplus.cn` | åª’ä½“ CDN | VPS (31.40.214.114) |

### VPS é…ç½® (Hostdare LA CN2)

- **IP**: 31.40.214.114
- **Nginx é…ç½®**: `/etc/nginx/conf.d/`
  - `platform-proxy.conf` - å¹³å°å…¨ç«™åå‘ä»£ç†
  - `r2-proxy.conf` - åª’ä½“ CDN åå‘ä»£ç†
- **SSL**: Let's Encrypt è‡ªåŠ¨ç»­æœŸ

## Railway Services

é¡¹ç›®éƒ¨ç½²åœ¨ Railway `profound-wisdom` é¡¹ç›®ä¸­ï¼š

| Service | Description | Endpoint |
|---------|-------------|----------|
| playerplus-backend | Go åç«¯ + Vue å‰ç«¯ | `platform.playerplus.cn` |
| PostgreSQL | ä¸»æ•°æ®åº“ | `nozomi.proxy.rlwy.net:28246/railway` |

### å­˜å‚¨é…ç½®

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|-----|------|
| `STORAGE_PUBLIC_URL` | `https://cdn.playerplus.cn` | CDN URL (ä¸­å›½ç”¨æˆ·è®¿é—®) |
| `STORAGE_DIRECT_URL` | `https://pub-xxx.r2.dev` | R2 ç›´è¿ URL (VModel API è®¿é—®) |
| `MINIO_PUBLIC_ENDPOINT` | `xxx.r2.cloudflarestorage.com` | R2 S3 API ç«¯ç‚¹ |

### è‡ªåŠ¨éƒ¨ç½² (Gitee Webhook)

æ¨é€ä»£ç åˆ° `main` åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘ Railway éƒ¨ç½²ï¼š

```
Gitee Push (main) â†’ VPS Webhook â†’ Railway API â†’ è‡ªåŠ¨æ„å»ºéƒ¨ç½²
```

| é…ç½®é¡¹ | å€¼ |
|--------|-----|
| Webhook URL | `https://platform.playerplus.cn/deploy-webhook` |
| è§¦å‘åˆ†æ”¯ | `main` / `master` |
| Webhook æœåŠ¡ | VPS `/opt/railway-webhook/railway_webhook.py` |

## Auth

- **å½“å‰**: é‚®ç®±éªŒè¯ç ç™»å½•ï¼ˆAliyun DirectMailï¼‰
  - é™åˆ¶ `@playerplus.cn` åŸŸå
  - éªŒè¯ç æœ‰æ•ˆæœŸ 10 åˆ†é’Ÿ
  - é‡å‘å†·å´ 5 åˆ†é’Ÿ
- **å¤‡ç”¨**: å›ºå®šè´¦å·å¯†ç ç™»å½• (`test` / `test`)
- Token å­˜å‚¨åœ¨ localStorageï¼Œæœ‰æ•ˆæœŸ 7 å¤©

## Development Progress

### âœ… å·²å®Œæˆ

- [x] é¡¹ç›®åŸºç¡€æ¶æ„ï¼ˆGo + Vue + Railwayï¼‰
- [x] ç”¨æˆ·è®¤è¯ï¼ˆåŸºç¡€ç™»å½•ï¼‰
- [x] Cloudflare R2 å­˜å‚¨é›†æˆ
- [x] VModel æ¢è„¸ API é›†æˆ
  - äººè„¸æ£€æµ‹ API
  - å¤šäººè„¸é€‰æ‹©åŠŸèƒ½
  - å¼‚æ­¥æ¢è„¸å¤„ç†
  - ç»“æœè½®è¯¢å’Œä¸‹è½½
- [x] æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®
- [x] è§†é¢‘ä¸Šä¼ è¿›åº¦æ¡æ˜¾ç¤º
- [x] è§†é¢‘ç»“æœè½¬å­˜åˆ° R2ï¼ˆè§£å†³ VModel CDN å›½å†…è®¿é—®é—®é¢˜ï¼‰
- [x] å­˜å‚¨ç¼“å­˜ TTL æœºåˆ¶ï¼ˆ24å°æ—¶è‡ªåŠ¨æ¸…ç†ï¼‰
- [x] è½¬å­˜è¿›åº¦çŠ¶æ€ï¼ˆtransferring çŠ¶æ€ï¼Œè½¬å­˜å®Œæˆåæ‰æ˜¾ç¤ºæˆåŠŸï¼‰
- [x] è‡ªå®šä¹‰åŸŸåé…ç½®ï¼ˆplatform.playerplus.cnï¼‰
- [x] VPS å…¨ç«™åå‘ä»£ç†ï¼ˆCN2 åŠ é€Ÿä¸­å›½è®¿é—®ï¼‰
- [x] åª’ä½“ CDN é…ç½®ï¼ˆcdn.playerplus.cnï¼‰
- [x] VModel API ç›´è¿ R2ï¼ˆè§£å†³é¦–æ¬¡æ£€æµ‹è¶…æ—¶é—®é¢˜ï¼‰
- [x] å¼‚æ­¥äººè„¸æ£€æµ‹é‡æ„ï¼ˆè§£å†³å®¢æˆ·ç«¯ 60s è¶…æ—¶é—®é¢˜ï¼‰
  - åç«¯è¿”å› task_id ç«‹å³å“åº”
  - å‰ç«¯è½®è¯¢æ£€æµ‹çŠ¶æ€
  - æ”¯æŒ Mock æ¨¡å¼å‘åå…¼å®¹
- [x] è§†é¢‘è½¬å­˜ç«æ€æ¡ä»¶ä¿®å¤ï¼ˆper-task lockingï¼‰
- [x] VModel API é‡è¯•æœºåˆ¶ï¼ˆGET è¯·æ±‚æŒ‡æ•°é€€é¿ï¼‰
- [x] é‚®ç®±éªŒè¯ç ç™»å½•ï¼ˆAliyun DirectMailï¼‰

### ğŸš§ è¿›è¡Œä¸­

- [ ] é…ç½® Resend é‚®ä»¶æœåŠ¡ï¼ˆå¤‡ç”¨ï¼‰

### ğŸ“‹ å¾…å¼€å‘

- [ ] Prompt ç®¡ç†åŠŸèƒ½
- [ ] LLM æ–‡æ¡ˆç”Ÿæˆ
- [ ] ä¸€é”®æ¢è£… (V2)
- [ ] æ‰¹é‡å¤„ç† (V2)
